<!DOCTYPE html>
<html>
<head>
<link href='css/fullcalendar.css' rel='stylesheet' />
<script src='js/jquery.min.js'></script>
<script src='js/jquery-ui.custom.min.js'></script>
<script src='js/moment.min.js'></script>
<script src='js/fullcalendar.js'></script>
<script src='js/en-gb.js'></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script>
  var this_url = "http://fact-project.org/sandbox/dneise/shiftcalendar/";
  $(document).ready(function() {
    $.ajax({
      url: this_url + 'usernames.php',
      dataType: "json",
      success: function(json) {
        json.forEach(function(val, index){
          $("#username").append("<option>" + val["username"] + "</option>");
        });
      },
    });

    $("#role").empty();
    $("#role").append("<option>" + "1st shifter" + "</option>");
    $("#role").append("<option>" + "2nd shifter" + "</option>");
    $("#role").append("<option>" + "expert on call" + "</option>");
    $("#role").append("<option>" + "fallback shifter" + "</option>");

    var username_choice = "";
    var role_choice = "";
    var role_color = {
      "1st shifter": "DarkRed",
      "2nd shifter": "Green",
      "expert on call": "Red",
      "fallback shifter": "LightSeaGreen",
    };

    $("#username").change(function() {
      username_choice = $(this).val();
    });

    $("#role").change(function() {
      role_choice = $(this).val();
    });

    var calendar = $('#calendar').fullCalendar({

    views: {
      agenda: {
        // options apply to basicWeek and agendaWeek views
        slotDuration: "01:00:00",
        minTime: "12:00:00",
        maxTime: "1.12:00:00",
        allDayText: "all night",
      },
    },

    editable: true,
    defaultTimedEventDuration: "06:00:00",
    forceEventDuration: true,
    events: this_url + "events.php",
    selectable: true,
    selectHelper: true,

    header: {
      left: 'prev,next today',
      center: 'title',
      right: 'month,agendaWeek,agendaDay'
    },

    eventDataTransform: function( event ) {
      event.color = role_color[event.role];
      return event;
    },

    eventRender: function(event, element) {
      $(element).tooltip({title: event.role});
    },

    select: function(start, end) {
      var title = username_choice;
      var role = role_choice;
      if (title) {
        var allDay = false;
        if (!start.hasTime() ){
          allDay = true;
        }
        var start = start.format();
        var end = end.format();
        $.ajax({
          url: this_url + 'add_events.php',
          data: 'title='+ title +'&start='+ start +'&end='+ end +'&role=' + role ,
          type: "POST",
        });

        calendar.fullCalendar(
          'renderEvent',
          {
            title: title,
            start: start,
            end: end,
            allDay: allDay,
            role: role,
            color: role_color[role],
          },
          true // make the event "stick"
        );
      }
      calendar.fullCalendar('unselect');
    },

    eventDrop: function(event, delta) {
      var start = event.start.format()
      var end = event.end.format();
      $.ajax({
        url: this_url + 'update_events.php',
        data: 'title='+ event.title+'&start='+ start +'&end='+ end +'&id='+ event.id ,
        type: "POST",
      });
    },

    eventResize: function(event) {
      var start = event.start.format();
      var end = event.end.format();
      $.ajax({
        url: this_url + 'update_events.php',
        data: 'title='+ event.title+'&start='+ start +'&end='+ end +'&id='+ event.id ,
        type: "POST",
      });
    },

    eventClick: function(event) {
      if (confirm("Would you like to delete this?")) {
        $.ajax({
          type: "POST",
          url: this_url + "delete_event.php",
          data: "&id=" + event.id
        });
        calendar.fullCalendar('removeEvents', event.id);
      }
      return false;
    },
  });
});

</script>
<style>
  body {
    margin-top: 40px;
    text-align: center;
    font-size: 14px;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
  }

  #calendar {
    width: 900px;
    margin: 0 auto;
  }
</style>
</head>
<body>

<div id='calendar'></div>

<select id="username">
  <option>Please choose a username</option>
</select>

<select id="role">
  <option>Please choose a role</option>
</select>

</body>
</html>

